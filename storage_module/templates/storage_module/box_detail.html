{% extends 'storage_module/base_storage.html' %}
{% load storage_module_extras %}

{% block extra_script %}
    <script>
        $(document).ready(function () {

            $('.dropdown-item').click(function (event) {
                event.preventDefault();
                $('#selected-action').val($(this).attr('value'));
                $('#bulk-actions-form').submit();
            });

            $('#bulk-actions-form').submit(function (event) {
                const selectedSamples = $('input[type="checkbox"][name="sample_ids"]:checked');
                if (selectedSamples.length === 0) {
                    alert("Please select at least one sample");
                    event.preventDefault(); // Stops the form submission
                }
            });

            $('#select-all').change(function () {
                $('input[type="checkbox"][name="sample_ids"]').prop('checked', $(this).is(':checked'));
            });

            $('input[type="checkbox"][name="sample_ids"]').change(function () {
                if (!$(this).is(':checked')) {
                    $('#select-all').prop('checked', false);
                }
            });

            $('a[data-bs-toggle="offcanvas"]').on('click', function (event) {
                event.preventDefault();
                var sampleIdContent = $(this).text();
                var sampleId = sampleIdContent.trim();

                $.get('/get_sample_details/' + sampleId, function (data) {
                    $('#sampleDetailsBody').empty();

                    var newDetailsContent = `
                        <aside >
                            <div class="card mb-4">
                                <div class="card-body">
                                    <h2 class="card-title">${data.sample_id}'s Information</h2>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item"><strong>Type:</strong> ${data.sample_type}</li>
                                        <li class="list-group-item"><strong>Source File:</strong> ${data.source_file}</li>
                                        <li class="list-group-item"><strong>Time Sampled:</strong> ${data.time_sampled}</li>
                                        <li class="list-group-item"><strong>Condition:</strong> ${data.sample_condition}</li>
                                        <li class="list-group-item"><strong>Created By:</strong> ${data.user_created}</li>
                                        <li class="list-group-item"><strong>Participant ID:</strong> ${data.participant_id}</li>
                                        <li class="list-group-item"><strong>Gender:</strong> ${data.gender}</li>
                                        <li class="list-group-item"><strong>Date of Birth:</strong> ${data.date_of_birth}</li>
                                        <li class="list-group-item"><strong>Date Sampled:</strong> ${data.date_sampled}</li>
                                        <li class="list-group-item"><strong>Requisition ID:</strong> ${data.requisition_id}</li>
                                        <li class="list-group-item"><strong>Protocol Number:</strong> ${data.protocol_number}</li>
                                        <li class="list-group-item"><strong>Status:</strong> <span class="badge badge-pill badge-warning bg-warning">${data.sample_status}</span></li>
                                    </ul>
                                </div>
                            </div>
                            <!-- Add More Divs as needed -->
                            <!-- Actions and Notes -->
                            <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-4">
                                <button type="button" class="btn btn-success">Share</button>
                                <button type="button" class="btn btn-warning">Export</button>
                                <a href="/move_samples/?sample_ids=${data.sample_id}" class="btn btn-primary" role="button">
                                    Move Sample
                                </a>
                            </div>
                        </aside>
                    `;
                    // Append the new details to the DOM
                    $('#sampleDetailsBody').append(newDetailsContent);
                });
            });

            $('body').on('change', '#id_freezer', function () {
                var freezerId = $(this).val();

                $.ajax({
                    url: "/get_shelves/",
                    data: {
                        'freezer_id': freezerId
                    },
                    success: function (data) {
                        var select = $('#id_shelf');
                        select.empty();
                        $.each(data, function (key, value) {
                            select.append($('<option></option>').attr('value', value.id).text(value.shelf_name));
                        });
                    }
                });

                $.ajax({
                    url: "/get_racks/",
                    data: {
                        'freezer_id': freezerId
                    },
                    success: function (data) {
                        var select = $('#id_rack');
                        select.empty();
                        $.each(data, function (key, value) {
                            select.append($('<option></option>').attr('value', value.id).text(value.rack_name));
                        });
                    }
                });


            });
            $('.select2').select2();
        });
    </script>

    <style>
        .select2-container--default .select2-selection--single {
            width: 465px !important; /* Set the width to your preference */
        }

        .container {
            margin-left: 10rem;
            min-height: 100vh;
            margin: 0;
        }
    </style>
{% endblock %}

{% block hierarchy %}
    {% if box.location.facility %}
        <a href="{% url 'facility_detail' box.location.facility.id %}"
           class="breadcrumb-item">
            <i class="fas fa-warehouse"></i>
            {{ box.location.facility.facility_name }}
        </a>
    {% endif %}
    {% if box.location.freezer %}
        <a href="{% url 'freezer_detail' box.location.freezer.id %}"
           class="breadcrumb-item">
            <i class="fas fa-snowflake"></i>{{ box.location.freezer.freezer_name }}
        </a>
    {% endif %}
    {% if box.location.shelf %}
        <i class="fas fa-layer-group"></i>
        <a href="{% url 'shelf_detail' box.location.shelf.id %}" class="breadcrumb-item">
            <i class="fas fa-layer-group"></i>{{ box.location.shelf.shelf_name }}
        </a>
    {% endif %}
    {% if box.location.rack %}
        <a href="{% url 'rack_detail' box.location.rack.id %}" class="breadcrumb-item">
            <i class="fas fa-box-open"></i>{{ box.location.rack.rack_name }}
        </a>
    {% endif %}

    <span class="breadcrumb-item active">
        <i class="fas fa-cube"></i> {{ box.box_name }}
    </span>
{% endblock %}

{% block storage_view %}
    <div class="d-flex flex-row">
        <i class="fas fa-cube"
           style="font-size: 5rem;"></i>
        <div class="d-flex flex-column" style="margin-left: 10px">
            <span style="font-size: 1.5rem;">{{ box.box_name }}</span>
            <span style="font-size: 1rem;">Storage View</span>
        </div>
    </div>
{% endblock %}
{% block status %}
{% endblock %}

{% block page_content %}
    <form id="bulk-actions-form" method="post">
        {% csrf_token %}
        <input type="hidden" id="selected-action" name="action">
        <div class="d-flex flex-row align-items-center">
            <div class="d-flex m-1">
                <button type="button" class="btn btn-primary" data-toggle="modal"
                        data-target="#moveBoxModal">
                    Move Box
                </button>
            </div>
            <div class="d-flex m-1">
                <button class="btn btn-outline-dark dropdown-toggle" type="button"
                        id="bulk-actions-dropdown" data-toggle="dropdown"
                        aria-haspopup="true" aria-expanded="false" style="height: 2.5rem">
                    ---Other Action---
                </button>

                <div class="dropdown-menu" aria-labelledby="bulk-actions-dropdown">
                    <button class="dropdown-item" type="button" value="move">Move
                        Samples
                    </button>
                    <button class="dropdown-item" type="button" value="export">Export
                    </button>
                    {% for status in sample_statuses %}
                        {% if not status.name == 'In Storage' %}
                            <button class="dropdown-item" type="button"
                                    value="{{ status.id }}">
                                {{ status.name }}
                            </button>
                        {% endif %}
                    {% endfor %}
                    <button class="dropdown-item" type="button" value="print">Printing
                        Barcodes or Labels
                    </button>
                </div>
            </div>
        </div>
        <div class="d-flex flex-column mt-4">
            <div class="row">
                <div class="card d-flex align-items-center justify-content-center"
                     style="margin: 3px; height: 4rem; width: 4rem;">
                    <input type="checkbox" id="select-all">
                </div>
                {% for x in x_labels %}
                    <div class="card" style="margin: 3px; height: 4rem; width: 4rem;">
                        <div class="card-body d-flex align-items-center justify-content-center">
                            {{ x }}
                        </div>
                    </div>
                {% endfor %}
            </div>
            {% for y in y_labels %}
                <div class="row">
                    <div class="card" style="margin: 3px; height: 4rem; width: 4rem;">
                        <div class="card-body d-flex align-items-center justify-content-center">
                            {{ y }}
                        </div>
                    </div>
                    {% for x in x_labels %}
                        <div class="card bg-light"
                             style="margin: 3px; height: 4rem; width: 4rem;">
                            <div class="card-body d-flex flex-column align-items-center justify-content-center"
                                 style="padding: 0">
                                {% for position in positions %}
                                    {% if position.x_position == forloop.parentloop.counter0 and position.y_position == y %}
                                        <input type="checkbox" name="sample_ids"
                                               value="{{ position.sample.sample_id }}">
                                        <a class="text-center " style="font-size: 9px"
                                           href="#" data-bs-toggle="offcanvas"
                                           data-bs-target="#sampleDetailsDrawer">
                                            <i class="fas fa-vial"></i>
                                            {{ position.sample.sample_id }}
                                        </a>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    </form>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="sampleDetailsDrawer">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Sample Details</h5>
            <button type="button" class="btn-close text-reset"
                    data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body" id="sampleDetailsBody"></div>
    </div>
{% endblock %}