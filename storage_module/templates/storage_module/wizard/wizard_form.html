{% extends 'storage_module/base.html' %}
{% load storage_module_extras %}
{% load widget_tweaks %}

{% block extra_script %}
    <script>
        $(document).ready(function () {
            $('.btn-primary').click(function (e) {
                e.preventDefault();
                var validationResult = true;
                var url = "{% url 'ajax_validate_position' %}";
                var box = "{{ request.session.selected_box }}";
                var positions = {};

                var x_positions = $('select[id^="id_form"][id$="-new_x_position"]');
                var y_positions = $('select[id^="id_form"][id$="-new_y_position"]');

                x_positions.each(function (index, element) {
                    var x_position = $(element).val();
                    var y_position = y_positions.eq(index).val();
                    var posKey = x_position + 'x' + y_position;

                    if (positions[posKey]) {
                        validationResult = false;
                        alert("Two samples cannot be placed into the same position (" + x_position + ", " + y_position + ")");
                        return;
                    }

                    $.ajax({
                        url: url,
                        type: 'get',
                        data: {
                            "sample": index + 1,
                            "box": box,
                            "x_position": x_position,
                            "y_position": y_position
                        },
                        success: function (data) {
                            if (data.error) {
                                validationResult = false;
                                alert(data.error.message);
                            } else {
                                positions[posKey] = true;
                            }
                        },
                        async: false
                    });

                    if (!validationResult) return;
                });

                if (validationResult) {
                    $('form').submit();
                }
            });
            $(".btn-outline-secondary").click(function (event) {
                event.preventDefault();
                var prevStep = "{{ wizard.steps.prev }}";
                var form = document.createElement("form");
                form.method = "POST";
                var csrfInput = document.createElement("input");
                csrfInput.type = "hidden";
                csrfInput.name = "csrfmiddlewaretoken";
                csrfInput.value = "{{ csrf_token }}";
                form.appendChild(csrfInput);
                var hiddenInput = document.createElement("input");
                hiddenInput.type = "hidden";
                hiddenInput.name = "wizard_goto_step";
                hiddenInput.value = prevStep;
                form.appendChild(hiddenInput);
                document.body.appendChild(form);
                form.submit();
            });

        });
    </script>

    <style>
        .container {
            margin-left: 10rem;
            min-height: 100vh;
            margin: 0;
        }
    </style>

{% endblock %}

{% block content %}
    <body>
    <div class="container mt-5">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="mb-0">Move Samples: Step {{ wizard.steps.step1 }}
                    of {{ wizard.steps.count }}</h2>
                <button type="button"
                        class="btn btn-sm btn-outline-light"
                        data-toggle="tooltip"
                        data-placement="top"
                        title="Help">
                    <i class="fas fa-question-circle"></i>
                </button>
            </div>
            <form method="POST" class="card-body">
                {% csrf_token %}
                {{ wizard.management_form }}
                {% if wizard.form.forms %}
                    {{ wizard.form.management_form }}
                    {% for form in wizard.form %}
                        <div class="form-group mb-3">
                            <div><strong>Sample ID: {{ form.initial.sample_id }}</strong>
                            </div>
                            {% if form is not None and form.fields %}
                                {{ form }}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    {% for field in wizard.form %}
                        <div class="form-group mb-3">
                            {{ field.label_tag }}
                            {{ field|add_class:"form-control form-control-sm" }}
                        </div>
                    {% endfor %}
                {% endif %}
                <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary"
                            type="submit"
                            name="wizard_goto_step"
                            value="{{ wizard.steps.prev }}"
                            {% if not wizard.steps.prev %}
                            disabled
                            {% endif %}>
                        <i class="fas fa-arrow-left"></i> Previous
                    </button>
                    <button class="btn btn-primary" type="submit">Next <i
                            class="fas fa-arrow-right"></i></button>
                </div>
            </form>
        </div>
    </div>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    </body>
{% endblock %}
